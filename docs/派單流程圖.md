### 即時單派單流程

* 一般訂單(即時單)的流程: 新訂單 -> 前往客上 -> 拍照/略過 -> 客人報到 -> 行程進行中

---

## 🚕 即時單派單流程

1. **接受訂單** → `POST /drivers/accept-order`

    * `driver_status`: 閒置 → 前往上車點
    * `order_status`: 等待接單 → 前往上車點

2. **司機抵達時間記錄** → `POST /driver/arrive-pickup-location`

    * 僅記錄抵達時間，**無狀態變更**

3. **拍照上傳** → `POST /drivers/orders/{orderId}/upload-pickup-certificate`

    * `driver_status`: 前往上車點 → 司機抵達
    * `order_status`: 前往上車點 → 司機抵達

4. **略過拍照** → `POST /drivers/orders/{id}/skip-pickup-certificate`

    * `driver_status`: 前往上車點 → 司機抵達
    * `order_status`: 前往上車點 → 司機抵達

5. **客人上車** → `POST /drivers/orders/{id}/onboard`

    * `driver_status`: 司機抵達 → 執行任務
    * `order_status`: 司機抵達 → 執行任務

6. **完成訂單** → `POST /drivers/complete-order`

    * `driver_status`: 執行任務 → 閒置
    * `order_status`: 執行任務 → 完成

---

## 📅 預約單派單流程

1. **接受預約單** → `POST /order-schedule/accept`

    * `driver_status`: 閒置 → 閒置 (暫不變)
    * `order_status`: 等待接單 → 預約單被接受

2. **激活預約單** → `POST /order-schedule/{id}/activate`

    * `driver_status`: 閒置 → 前往上車點
    * `order_status`: 預約單被接受 → 前往上車點

3. **司機抵達時間記錄** → `POST /driver/arrive-pickup-location`

    * 僅記錄抵達時間，**無狀態變更**

4. **拍照上傳** → `POST /drivers/orders/{orderId}/upload-pickup-certificate`

    * `driver_status`: 前往上車點 → 司機抵達
    * `order_status`: 前往上車點 → 司機抵達

5. **略過拍照** → `POST /drivers/orders/{id}/skip-pickup-certificate`

    * `driver_status`: 前往上車點 → 司機抵達
    * `order_status`: 前往上車點 → 司機抵達

6. **客人上車** → `POST /drivers/orders/{id}/onboard`

    * `driver_status`: 司機抵達 → 執行任務
    * `order_status`: 司機抵達 → 執行任務

7. **完成訂單** → `POST /drivers/complete-order`

    * `driver_status`: 執行任務 → 閒置
    * `order_status`: 執行任務 → 完成

---

## 狀態枚舉說明

### OrderStatus (訂單狀態)
- `"等待接單"` - 新建立的訂單，等待司機接單
- `"預約單被接受"` - 預約單已被司機接受，但尚未激活
- `"前往上車點"` - 司機已接單/激活，正在前往上車點
- `"司機抵達"` - 司機已抵達上車點，完成拍照/略過拍照程序
- `"執行任務"` - 客人已上車，行程進行中
- `"完成"` - 訂單已完成
- `"乘客取消"` - 乘客取消訂單
- `"流單"` - 訂單流單（無司機接單或其他原因）
- `"系統失敗"` - 系統處理失敗

### DriverStatus (司機狀態)
- `"閒置"` - 司機空閒，可接新訂單
- `"前往上車點"` - 司機正在前往上車點
- `"司機抵達"` - 司機已抵達上車點
- `"執行任務"` - 司機正在執行乘車任務
- `"停用中"` - 司機已停用（管理功能）


---


### 📌 預約單相關 API

| API                                                                  | 更新卡片 | 回覆訊息 | 事件類型                    | 顯示距離時間 | 備註            |
| -------------------------------------------------------------------- | ---- | ---- | ----------------------- | ------ | ------------- |
| 1. 接受預約單 `POST /order-schedule/accept`                               | ✅    | ✅    | EventScheduledAccepted  | ❌      | 預約單格式，不顯示距離時間 |
| 2. 激活預約單 `POST /order-schedule/{id}/activate`                        | ✅    | ✅    | EventScheduledActivated | ✅      | 預約單格式，顯示距離時間  |
| 3. 司機抵達時間記錄 `POST /driver/arrive-pickup-location`                    | ❌    | ❌    | 無                       | -      | 只記錄時間，不發送通知   |
| 4.1. 拍照上傳 `POST /drivers/orders/{orderId}/upload-pickup-certificate` | ✅    | ✅    | EventDriverArrived      | ❌      | 拍照場景          |
| 4.2. 略過拍照 `POST /drivers/orders/{id}/skip-pickup-certificate`        | ✅    | ✅    | EventDriverArrived      | ❌      | 略過拍照場景        |
| 5. 客人上車 `POST /drivers/orders/{id}/onboard`                          | ✅    | ✅    | EventCustomerOnBoard    | ❌      | -             |
| 6. 完成訂單 `POST /drivers/complete-order`                               | ✅    | ❌    | EventOrderCompleted     | -      | 訂單完成不發送回覆     |

---

### 📌 一般單相關 API

| API                                                                  | 更新卡片 | 回覆訊息 | 事件類型                 | 顯示距離時間 | 備註           |
| -------------------------------------------------------------------- | ---- | ---- | -------------------- | ------ | ------------ |
| 1. 接受訂單 `POST /drivers/accept-order`                                 | ✅    | ✅    | EventDriverAccepted  | ✅      | 一般單格式，顯示距離時間 |
| 2. 司機抵達時間記錄 `POST /driver/arrive-pickup-location`                    | ❌    | ❌    | 無                    | -      | 只記錄時間，不發送通知  |
| 3.1. 拍照上傳 `POST /drivers/orders/{orderId}/upload-pickup-certificate` | ✅    | ✅    | EventDriverArrived   | ❌      | 拍照場景         |
| 3.2. 略過拍照 `POST /drivers/orders/{id}/skip-pickup-certificate`        | ✅    | ✅    | EventDriverArrived   | ❌      | 略過拍照場景       |
| 4. 客人上車 `POST /drivers/orders/{id}/onboard`                          | ✅    | ✅    | EventCustomerOnBoard | ❌      | -            |
| 5. 完成訂單 `POST /drivers/complete-order`                               | ✅    | ❌    | EventOrderCompleted  | -      | 訂單完成不發送回覆    |

---
### Jaeger Tracing 查詢

**常用 Trace 搜尋:**
- `operation:"dispatcher_handle_order"`: 派單主流程
- `operation:"accept_order_controller" AND tag:"order.id=<ORDER_ID>"`: 特定訂單接單追蹤
- `operation:"dispatcher_find_candidates" AND tag:"candidates.count>0"`: 成功找到候選司機的派單
- `operation:"dispatcher_send_fcm" AND tag:"fcm.result=driver_accepted"`: 成功接單的 FCM 推送
- `operation:"complete_order_controller"`: 完成訂單追蹤

**錯誤追蹤:**
- `tag:"error=true"`: 所有錯誤追蹤
- `tag:"dispatch.success=false"`: 派單失敗追蹤
- `tag:"http.status_code>=400"`: HTTP 錯誤追蹤
