### å³æ™‚å–®æ´¾å–®æµç¨‹

* ä¸€èˆ¬è¨‚å–®(å³æ™‚å–®)çš„æµç¨‹: æ–°è¨‚å–® -> å‰å¾€å®¢ä¸Š -> æ‹ç…§/ç•¥é -> å®¢äººå ±åˆ° -> è¡Œç¨‹é€²è¡Œä¸­

---

## ğŸš• å³æ™‚å–®æ´¾å–®æµç¨‹

1. **æ¥å—è¨‚å–®** â†’ `POST /drivers/accept-order`

    * `driver_status`: é–’ç½® â†’ å‰å¾€ä¸Šè»Šé»
    * `order_status`: ç­‰å¾…æ¥å–® â†’ å‰å¾€ä¸Šè»Šé»

2. **å¸æ©ŸæŠµé”æ™‚é–“è¨˜éŒ„** â†’ `POST /driver/arrive-pickup-location`

    * åƒ…è¨˜éŒ„æŠµé”æ™‚é–“ï¼Œ**ç„¡ç‹€æ…‹è®Šæ›´**

3. **æ‹ç…§ä¸Šå‚³** â†’ `POST /drivers/orders/{orderId}/upload-pickup-certificate`

    * `driver_status`: å‰å¾€ä¸Šè»Šé» â†’ å¸æ©ŸæŠµé”
    * `order_status`: å‰å¾€ä¸Šè»Šé» â†’ å¸æ©ŸæŠµé”

4. **ç•¥éæ‹ç…§** â†’ `POST /drivers/orders/{id}/skip-pickup-certificate`

    * `driver_status`: å‰å¾€ä¸Šè»Šé» â†’ å¸æ©ŸæŠµé”
    * `order_status`: å‰å¾€ä¸Šè»Šé» â†’ å¸æ©ŸæŠµé”

5. **å®¢äººä¸Šè»Š** â†’ `POST /drivers/orders/{id}/onboard`

    * `driver_status`: å¸æ©ŸæŠµé” â†’ åŸ·è¡Œä»»å‹™
    * `order_status`: å¸æ©ŸæŠµé” â†’ åŸ·è¡Œä»»å‹™

6. **å®Œæˆè¨‚å–®** â†’ `POST /drivers/complete-order`

    * `driver_status`: åŸ·è¡Œä»»å‹™ â†’ é–’ç½®
    * `order_status`: åŸ·è¡Œä»»å‹™ â†’ å®Œæˆ

---

## ğŸ“… é ç´„å–®æ´¾å–®æµç¨‹

1. **æ¥å—é ç´„å–®** â†’ `POST /order-schedule/accept`

    * `driver_status`: é–’ç½® â†’ é–’ç½® (æš«ä¸è®Š)
    * `order_status`: ç­‰å¾…æ¥å–® â†’ é ç´„å–®è¢«æ¥å—

2. **æ¿€æ´»é ç´„å–®** â†’ `POST /order-schedule/{id}/activate`

    * `driver_status`: é–’ç½® â†’ å‰å¾€ä¸Šè»Šé»
    * `order_status`: é ç´„å–®è¢«æ¥å— â†’ å‰å¾€ä¸Šè»Šé»

3. **å¸æ©ŸæŠµé”æ™‚é–“è¨˜éŒ„** â†’ `POST /driver/arrive-pickup-location`

    * åƒ…è¨˜éŒ„æŠµé”æ™‚é–“ï¼Œ**ç„¡ç‹€æ…‹è®Šæ›´**

4. **æ‹ç…§ä¸Šå‚³** â†’ `POST /drivers/orders/{orderId}/upload-pickup-certificate`

    * `driver_status`: å‰å¾€ä¸Šè»Šé» â†’ å¸æ©ŸæŠµé”
    * `order_status`: å‰å¾€ä¸Šè»Šé» â†’ å¸æ©ŸæŠµé”

5. **ç•¥éæ‹ç…§** â†’ `POST /drivers/orders/{id}/skip-pickup-certificate`

    * `driver_status`: å‰å¾€ä¸Šè»Šé» â†’ å¸æ©ŸæŠµé”
    * `order_status`: å‰å¾€ä¸Šè»Šé» â†’ å¸æ©ŸæŠµé”

6. **å®¢äººä¸Šè»Š** â†’ `POST /drivers/orders/{id}/onboard`

    * `driver_status`: å¸æ©ŸæŠµé” â†’ åŸ·è¡Œä»»å‹™
    * `order_status`: å¸æ©ŸæŠµé” â†’ åŸ·è¡Œä»»å‹™

7. **å®Œæˆè¨‚å–®** â†’ `POST /drivers/complete-order`

    * `driver_status`: åŸ·è¡Œä»»å‹™ â†’ é–’ç½®
    * `order_status`: åŸ·è¡Œä»»å‹™ â†’ å®Œæˆ

---

## ç‹€æ…‹æšèˆ‰èªªæ˜

### OrderStatus (è¨‚å–®ç‹€æ…‹)
- `"ç­‰å¾…æ¥å–®"` - æ–°å»ºç«‹çš„è¨‚å–®ï¼Œç­‰å¾…å¸æ©Ÿæ¥å–®
- `"é ç´„å–®è¢«æ¥å—"` - é ç´„å–®å·²è¢«å¸æ©Ÿæ¥å—ï¼Œä½†å°šæœªæ¿€æ´»
- `"å‰å¾€ä¸Šè»Šé»"` - å¸æ©Ÿå·²æ¥å–®/æ¿€æ´»ï¼Œæ­£åœ¨å‰å¾€ä¸Šè»Šé»
- `"å¸æ©ŸæŠµé”"` - å¸æ©Ÿå·²æŠµé”ä¸Šè»Šé»ï¼Œå®Œæˆæ‹ç…§/ç•¥éæ‹ç…§ç¨‹åº
- `"åŸ·è¡Œä»»å‹™"` - å®¢äººå·²ä¸Šè»Šï¼Œè¡Œç¨‹é€²è¡Œä¸­
- `"å®Œæˆ"` - è¨‚å–®å·²å®Œæˆ
- `"ä¹˜å®¢å–æ¶ˆ"` - ä¹˜å®¢å–æ¶ˆè¨‚å–®
- `"æµå–®"` - è¨‚å–®æµå–®ï¼ˆç„¡å¸æ©Ÿæ¥å–®æˆ–å…¶ä»–åŸå› ï¼‰
- `"ç³»çµ±å¤±æ•—"` - ç³»çµ±è™•ç†å¤±æ•—

### DriverStatus (å¸æ©Ÿç‹€æ…‹)
- `"é–’ç½®"` - å¸æ©Ÿç©ºé–’ï¼Œå¯æ¥æ–°è¨‚å–®
- `"å‰å¾€ä¸Šè»Šé»"` - å¸æ©Ÿæ­£åœ¨å‰å¾€ä¸Šè»Šé»
- `"å¸æ©ŸæŠµé”"` - å¸æ©Ÿå·²æŠµé”ä¸Šè»Šé»
- `"åŸ·è¡Œä»»å‹™"` - å¸æ©Ÿæ­£åœ¨åŸ·è¡Œä¹˜è»Šä»»å‹™
- `"åœç”¨ä¸­"` - å¸æ©Ÿå·²åœç”¨ï¼ˆç®¡ç†åŠŸèƒ½ï¼‰


---


### ğŸ“Œ é ç´„å–®ç›¸é—œ API

| API                                                                  | æ›´æ–°å¡ç‰‡ | å›è¦†è¨Šæ¯ | äº‹ä»¶é¡å‹                    | é¡¯ç¤ºè·é›¢æ™‚é–“ | å‚™è¨»            |
| -------------------------------------------------------------------- | ---- | ---- | ----------------------- | ------ | ------------- |
| 1. æ¥å—é ç´„å–® `POST /order-schedule/accept`                               | âœ…    | âœ…    | EventScheduledAccepted  | âŒ      | é ç´„å–®æ ¼å¼ï¼Œä¸é¡¯ç¤ºè·é›¢æ™‚é–“ |
| 2. æ¿€æ´»é ç´„å–® `POST /order-schedule/{id}/activate`                        | âœ…    | âœ…    | EventScheduledActivated | âœ…      | é ç´„å–®æ ¼å¼ï¼Œé¡¯ç¤ºè·é›¢æ™‚é–“  |
| 3. å¸æ©ŸæŠµé”æ™‚é–“è¨˜éŒ„ `POST /driver/arrive-pickup-location`                    | âŒ    | âŒ    | ç„¡                       | -      | åªè¨˜éŒ„æ™‚é–“ï¼Œä¸ç™¼é€é€šçŸ¥   |
| 4.1. æ‹ç…§ä¸Šå‚³ `POST /drivers/orders/{orderId}/upload-pickup-certificate` | âœ…    | âœ…    | EventDriverArrived      | âŒ      | æ‹ç…§å ´æ™¯          |
| 4.2. ç•¥éæ‹ç…§ `POST /drivers/orders/{id}/skip-pickup-certificate`        | âœ…    | âœ…    | EventDriverArrived      | âŒ      | ç•¥éæ‹ç…§å ´æ™¯        |
| 5. å®¢äººä¸Šè»Š `POST /drivers/orders/{id}/onboard`                          | âœ…    | âœ…    | EventCustomerOnBoard    | âŒ      | -             |
| 6. å®Œæˆè¨‚å–® `POST /drivers/complete-order`                               | âœ…    | âŒ    | EventOrderCompleted     | -      | è¨‚å–®å®Œæˆä¸ç™¼é€å›è¦†     |

---

### ğŸ“Œ ä¸€èˆ¬å–®ç›¸é—œ API

| API                                                                  | æ›´æ–°å¡ç‰‡ | å›è¦†è¨Šæ¯ | äº‹ä»¶é¡å‹                 | é¡¯ç¤ºè·é›¢æ™‚é–“ | å‚™è¨»           |
| -------------------------------------------------------------------- | ---- | ---- | -------------------- | ------ | ------------ |
| 1. æ¥å—è¨‚å–® `POST /drivers/accept-order`                                 | âœ…    | âœ…    | EventDriverAccepted  | âœ…      | ä¸€èˆ¬å–®æ ¼å¼ï¼Œé¡¯ç¤ºè·é›¢æ™‚é–“ |
| 2. å¸æ©ŸæŠµé”æ™‚é–“è¨˜éŒ„ `POST /driver/arrive-pickup-location`                    | âŒ    | âŒ    | ç„¡                    | -      | åªè¨˜éŒ„æ™‚é–“ï¼Œä¸ç™¼é€é€šçŸ¥  |
| 3.1. æ‹ç…§ä¸Šå‚³ `POST /drivers/orders/{orderId}/upload-pickup-certificate` | âœ…    | âœ…    | EventDriverArrived   | âŒ      | æ‹ç…§å ´æ™¯         |
| 3.2. ç•¥éæ‹ç…§ `POST /drivers/orders/{id}/skip-pickup-certificate`        | âœ…    | âœ…    | EventDriverArrived   | âŒ      | ç•¥éæ‹ç…§å ´æ™¯       |
| 4. å®¢äººä¸Šè»Š `POST /drivers/orders/{id}/onboard`                          | âœ…    | âœ…    | EventCustomerOnBoard | âŒ      | -            |
| 5. å®Œæˆè¨‚å–® `POST /drivers/complete-order`                               | âœ…    | âŒ    | EventOrderCompleted  | -      | è¨‚å–®å®Œæˆä¸ç™¼é€å›è¦†    |

---
### Jaeger Tracing æŸ¥è©¢

**å¸¸ç”¨ Trace æœå°‹:**
- `operation:"dispatcher_handle_order"`: æ´¾å–®ä¸»æµç¨‹
- `operation:"accept_order_controller" AND tag:"order.id=<ORDER_ID>"`: ç‰¹å®šè¨‚å–®æ¥å–®è¿½è¹¤
- `operation:"dispatcher_find_candidates" AND tag:"candidates.count>0"`: æˆåŠŸæ‰¾åˆ°å€™é¸å¸æ©Ÿçš„æ´¾å–®
- `operation:"dispatcher_send_fcm" AND tag:"fcm.result=driver_accepted"`: æˆåŠŸæ¥å–®çš„ FCM æ¨é€
- `operation:"complete_order_controller"`: å®Œæˆè¨‚å–®è¿½è¹¤

**éŒ¯èª¤è¿½è¹¤:**
- `tag:"error=true"`: æ‰€æœ‰éŒ¯èª¤è¿½è¹¤
- `tag:"dispatch.success=false"`: æ´¾å–®å¤±æ•—è¿½è¹¤
- `tag:"http.status_code>=400"`: HTTP éŒ¯èª¤è¿½è¹¤
